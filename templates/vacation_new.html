{% extends "base.html" %}
{% load user_filters %}
{% load cache %}
{% load static %}
{% block title %}Добавить отпуск{% endblock %}
{% block header %}
<title>Добавление отпуска</title>
<div style="display: flex; flex-direction: row; justify-content: left; align-items: center; flex-wrap: nowrap;">
    <a style="color: black; font-weight: bold; font-size: 28px; text-align: left; line-height: 50px; white-space: nowrap; margin-left: 358px;">Добавление отпуска на {{ year }}</a>
</div>

<style>
    .table-container { width: 780px; margin: 0 auto; margin-top: 20px; margin-left: 358px; padding: 30px; background-color: white; box-shadow: 0px 0px 4px rgba(0, 0, 0, 0.2); border-radius: 5px; }
	.btn-edit { background-color: #15a362; font-family: 'Calibri'; font-style: normal; width: 180px; height: 40px; font-weight: 700; font-size: 18px; padding: 0 10px; border-radius: 5px; color: white; text-align: center; display: flex; align-items: center; justify-content: center; text-decoration: none; text-transform: none; margin: 0;}
	.btn-my-vacations { background-color: white; color: #5d6778; border: 1px solid #ccc; font-family: 'Calibri'; font-style: normal; font-weight: 700; width: 110px; height: 40px; font-size: 18px; padding: 0 10px; border-radius: 5px; text-align: center; display: flex; align-items: center; justify-content: center; text-decoration: none; margin-left: 30px; }
	.btn-edit:hover { background-color: rgba(21, 163, 98, 0.8); text-decoration: none; color: white; }
    .btn-edit:focus { outline: none; }
	.btn-my-vacations:hover { text-decoration: none; color: #15a362 !important; border: 1px solid #15a362; }
    .darker { color: #15a362; font-size: 17px; text-decoration: underline; cursor: pointer; }
    .darker:hover { color: green; }
    .tooltip-container { position: relative; display: inline-block; }
    .tooltip-text { visibility: hidden; width: 200px; background-color: rgba(0, 0, 0, 0.9); color: white; text-align: center; border-radius: 5px; padding: 5px; position: absolute; z-index: 2; bottom: 120%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 15px; }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    .tooltip-text::after { content: ""; position: absolute; bottom: -9px; left: 50%; transform: translateX(-50%); width: 0; height: 0; z-index: 1; border-left: 7px solid transparent; border-right: 7px solid transparent; border-top: 9px solid rgba(0, 0, 0, 0.9); }
    .input-with-icon { background-image: url("{% static 'keyboard_arrow_down.svg' %}"); background-repeat: no-repeat; background-position: right 10px center; background-size: 24px; padding-right: 50px; font-size: 18px; width: 520px; border-radius: 5px; border: 1px solid #ddd; background-color: white;
    height: 45px; font-weight: normal; text-align: left; padding-left: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
    .input-with-icon:focus { border-color: #0d6efd; outline: none; }
    select#employee { font-size: 18px; width: 480px; border-radius: 5px; border: 1px solid #ddd; background-color: white; height: 43px; font-weight: normal; text-align: left; padding-left: 10px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: border-color 0.3s ease;
    background-image: url("{% static 'keyboard_arrow_down.svg' %}"); background-repeat: no-repeat; background-position: right 10px center; background-size: 24px; padding-right: 50px; }
    select#employee:focus { border-color: #0d6efd; outline: none; }
    select#department { font-size: 18px; width: 480px; border-radius: 5px; border: 1px solid #ddd; background-color: white; height: 43px; font-weight: normal; text-align: left; padding-left: 10px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: border-color 0.3s ease;
    background-image: url("{% static 'keyboard_arrow_down.svg' %}"); background-repeat: no-repeat; background-position: right 10px center; background-size: 24px; padding-right: 50px; }
    select#department:focus { border-color: #0d6efd; outline: none; }
    .form-control { width: 270px !important; height: 43px !important; font-size: 18px; background-color: white !important; border: 1px solid #ddd; border-radius: 5px; padding-left: 10px; transition: border-color 0.3s ease; }
    .form-control:focus { border-color: #0d6efd; outline: none; box-shadow: none; }
    .form-row { display: flex; align-items: center; margin-bottom: 20px; }
    .form-row.vacation-types-row { margin-bottom: 0px; }
    .field-label { font-size: 19px; flex: 0 0 230px; text-align: left; color: #5d6778; }
    .field-container { flex: 1; position: relative; }
    .field-container.has-errors { padding-bottom: 36px; }
    .vacation-types-inline { display: flex; align-items: center; gap: 20px; }
    .vacation-type-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .vacation-type-text { font-size: 16px; color: #5d6778; margin-left: 20px; }
    .vacation-types-inline input[type="checkbox"] { width: 16px; height: 16px; margin: 0; }
</style>
{% endblock %}

{% block aside %}
    {% include 'includes/aside_vac_all.html' %}
{% endblock %}

{% block content %}
<div class="table-container">
    <form method="post" enctype="multipart/form-data" style="width: 100%;">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="error"
             style="margin: 0 0 24px 0; color: red; font-size: 17px;">
            {{ form.non_field_errors|striptags }}
        </div>
        {% endif %}

        {% if is_boss %}
            {% if len_boss_departments > 1 %}
            <div class="form-row">
                <label for="department" class="field-label">
                        Отдел
                    </label>
                    <select name="department" id="department">
                        <option value=""
                            {% if selected_department|default:"" == "0" or selected_department|default:"" == "" %}
                                selected
                            {% endif %}>
                            Все отделы
                        </option>
                        {% for dept in departments %}
                            <option value="{{ dept.description }}"
                                {% if selected_department|default:'' == dept.description|stringformat:"s" %}selected{% endif %}>
                                {{ dept.title }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
        
            <div class="form-row">
                <label for="employee" class="field-label">
                    Сотрудник<span style="color: red;">&nbsp;*</span>
                </label>
                <select name="employee" id="employee">
                    {% for employee in employees %}
                        <option value="{{ employee.user.id }}" style="font-weight: normal;"
                            {% if employee.user.id|stringformat:"s" == selected_employee_id|stringformat:"s" %}selected{% endif %}
                        >
                            {{ employee.user.get_full_name }} 
                            {% if employee.position %}
                                ({{ employee.position.position }})
                            {% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
        {% endif %}

        {% for field in form %}
            <div class="form-row {% if field.name == 'unpaid' %}vacation-types-row{% endif %}">
                <label for="{{ field.id_for_label }}"
                    class="field-label">

                    {% if field.name != 'unpaid' and field.name != 'extra' %}
                        {{ field.label }}
                    {% endif %}

                    {% if field.name in "day_start day_end" %}
                        <span style="color: red;">*</span>
                    {% elif field.name == "how_long" %}
                        <span class="tooltip-container">
                            <img src="{% static 'question.svg' %}" alt="info"
                                style="width: 21px; height: 21px; cursor: pointer;">
                            <span class="tooltip-text">
                                Укажите количество календарных дней и дата окончания рассчитается автоматически.
                            </span>
                        </span>
                    {% endif %}
                </label>

                <div class="field-container">
                    {% if field.name == 'unpaid' %}
                        <div class="vacation-types-inline">
                            <label class="vacation-type-label">
                                {{ form.unpaid }}
                                <span class="vacation-type-text">Без содержания</span>
                            </label>

                            <label class="vacation-type-label">
                                {{ form.extra }}
                                <span class="vacation-type-text">Дополнительный</span>
                            </label>
                        </div>
                    {% elif field.name == 'extra' %}
                    {% else %}
                        {{ field }}
                        {% if field.errors %}
                        <div class="error"
                            style="position:absolute; top:100%; left:2px; margin-top:7px;
                                    font-size:16px; color:red; white-space:nowrap;">
                            {{ field.errors|striptags }}
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <div style="display: flex; justify-content: flex-start;">
            <button class="btn-edit" type="submit">Добавить отпуск</button>
            {% if employee_name %}
                <a class="btn-my-vacations" href="{% url 'vac_2' year=year otd=0 %}">Отмена</a>
            {% else %}
                {% if is_boss %}
                    <a class="btn-my-vacations" href="{% url 'vac_calendars' 0 %}">Отмена</a>
                {% else %}
                    <a class="btn-my-vacations" href="{% url 'vac_my_vacations' %}">Отмена</a>
                {% endif %}
            {% endif %}
        </div>
    </form>
</div>

<link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}">
<script src="{% static 'libs/flatpickr.min.js' %}"></script>
<script src="{% static 'libs/ru.js' %}"></script>

<script>
    const holidays = JSON.parse('{{ holidays_json|escapejs }}');

    $(document).ready(function() {
        var year = {{ year }};

        // Функция для расчета количества рабочих дней между двумя датами
        function calculateWorkingDays(startDateStr, endDateStr) {
            if (!startDateStr || !endDateStr) {
                return 0;
            }

            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];

            const startDateParts = startDateStr.split('-');
            const endDateParts = endDateStr.split('-');

            if (startDateParts.length !== 3 || endDateParts.length !== 3) {
                return 0;
            }

            // Устанавливаем даты с нулевым временем для точности
            let currentDate = new Date(Date.UTC(startDateParts[0], startDateParts[1] - 1, startDateParts[2]));
            const endDate = new Date(Date.UTC(endDateParts[0], endDateParts[1] - 1, endDateParts[2]));

            if (currentDate > endDate) {
                return 0;
            }

            let workingDays = 0;

            while (currentDate <= endDate) {
                const currentMonthName = monthNames[currentDate.getUTCMonth()];
                const currentDay = currentDate.getUTCDate();
                const monthHolidays = holidays[currentMonthName] || [];

                // Если день не является праздником, учитываем его
                if (!monthHolidays.includes(currentDay)) {
                    workingDays++;
                }

                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }

            return workingDays;
        }

        // Функция для расчета даты окончания по количеству дней
        function calculateEndDate(startDateStr, daysCount) {
            if (!startDateStr) return null;
            
            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];

            const startDateParts = startDateStr.split('-');
            if (startDateParts.length !== 3) {
                return null;
            }

            let remaining = parseInt(daysCount, 10);
            if (isNaN(remaining) || remaining < 1) {
                return startDateStr;
            }

            let currentDate = new Date(Date.UTC(startDateParts[0], startDateParts[1] - 1, startDateParts[2]));
            remaining--;

            while (remaining > 0) {
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);

                const currentMonthName = monthNames[currentDate.getUTCMonth()];
                const currentDay = currentDate.getUTCDate();
                const monthHolidays = holidays[currentMonthName] || [];

                if (!monthHolidays.includes(currentDay)) {
                    remaining--;
                }
            }

            const yyyy = currentDate.getUTCFullYear();
            const mm = String(currentDate.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(currentDate.getUTCDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // Функция для автоматического обновления количества дней
        function updateWorkingDays() {
            const startDateStr = $('#id_day_start').val();
            const endDateStr = $('#id_day_end').val();

            if (startDateStr && endDateStr) {
                const workingDays = calculateWorkingDays(startDateStr, endDateStr);
                if (workingDays > 0) {
                    $('#id_how_long').val(workingDays);
                } else {
                    $('#id_how_long').val('');
                }
            } else {
                $('#id_how_long').val('');
            }
        }

        // Функция для автоматического обновления даты окончания при изменении количества дней
        function updateEndDate() {
            const startDateStr = $('#id_day_start').val();
            const daysCountStr = $('#id_how_long').val();

            if (startDateStr && daysCountStr) {
                const endDateStr = calculateEndDate(startDateStr, daysCountStr);
                if (endDateStr) {
                    $('#id_day_end').val(endDateStr);
                    const endInput = document.getElementById('id_day_end');
                    if (endInput && endInput._flatpickr) {
                        endInput._flatpickr.setDate(endDateStr);
                    }
                    // Пересчитываем дни после обновления даты
                    setTimeout(updateWorkingDays, 100);
                }
            }
        }

        function setDatepicker(year) {
            var minDate = new Date(year, 0, 1);
            var maxDate = new Date(year, 11, 31);

            flatpickr('#id_day_start', {
                minDate: minDate,
                maxDate: maxDate,
                locale: 'ru',
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                allowInput: true,
                onChange: function(selectedDates, dateStr, instance) {
                    updateWorkingDays();
                    updateEndDate();
                },
            });

            flatpickr('#id_day_end', {
                minDate: minDate,
                maxDate: maxDate,
                locale: 'ru',
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                allowInput: true,
                onChange: function(selectedDates, dateStr, instance) {
                    updateWorkingDays();
                },
            });
        }

        setDatepicker(year);

        // Добавляем обработчики для ручного ввода дат
        $('#id_day_start').on('blur change', function() {
            updateWorkingDays();
            updateEndDate();
        });
        $('#id_day_end').on('blur change', function() {
            updateWorkingDays();
        });

        // Добавляем обработчик для автоматического расчета даты окончания при изменении количества дней
        $('#id_how_long').on('input change', function() {
            updateEndDate();
        });

        // Инициализируем количество дней при загрузке страницы, если даты уже заполнены
        setTimeout(function() {
            updateWorkingDays();
        }, 100);

        // Функция для получения реального значения даты из flatpickr
        function getRealDateValue(inputId) {
            var input = document.getElementById(inputId);
            if (!input) return null;
            
            if (input._flatpickr) {
                if (input._flatpickr.selectedDates.length > 0) {
                    return input._flatpickr.formatDate(input._flatpickr.selectedDates[0], 'Y-m-d');
                }
                if (input._flatpickr.input) {
                    var realValue = input._flatpickr.input.value;
                    if (realValue) return realValue;
                }
            }
            
            var value = $('#' + inputId).val();
            // Если значение в формате дд.мм.гггг, конвертируем в YYYY-MM-DD
            if (value && value.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                var parts = value.split('.');
                return parts[2] + '-' + parts[1] + '-' + parts[0];
            }
            return value;
        }

        $('form').submit(function(event) {
            var startDate = getRealDateValue('id_day_start');
            var endDate = getRealDateValue('id_day_end');
            
            if (!startDate || !endDate) {
                return true; // Разрешаем стандартную валидацию формы
            }

            var startParts = startDate.split('-');
            var endParts = endDate.split('-');

            if (startParts.length !== 3 || endParts.length !== 3) {
                return true;
            }

            var start = new Date(startParts[0], startParts[1] - 1, startParts[2]);
            var end = new Date(endParts[0], endParts[1] - 1, endParts[2]);
            var startYear = parseInt(startParts[0], 10);
            var endYear = parseInt(endParts[0], 10);

            if (start > end) {
                alert('Дата начала должна быть до даты окончания отпуска.');
                event.preventDefault();
                return false;
            }
            
            // Проверка на пересечение годов
            if (startYear !== endYear) {
                alert('Отпуск не может переходить на следующий календарный год.');
                event.preventDefault();
                return false;
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        const departmentSelect = document.getElementById("department");
        if (departmentSelect) {
            departmentSelect.addEventListener("change", function() {
                const selectedDept = this.value;
                const url = new URL(window.location.href);
                
                url.searchParams.set('department', selectedDept);

                window.location.href = url.toString();
            });
        }
    });
</script>
{% endblock %}