{% extends "base.html" %}
{% load cache %}
{% block title %}Календарь{% endblock %}
{% load user_filters %}
{% load static %}
{% block header %}
<title>Календарь отпусков</title>
<link rel="stylesheet" href="{% static 'css/sweetalert2.min.css' %}">
<script src="{% static 'libs/sweetalert2.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}">
<script src="{% static 'libs/flatpickr.min.js' %}"></script>
<script src="{% static 'libs/ru.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/select2.min.css' %}">
<script src="{% static 'libs/select2.min.js' %}"></script>
<div style="display: flex; flex-direction: row; justify-content: left; align-items: center; flex-wrap: nowrap; width: 100%;">
    <a style="color: black; font-weight: bold; font-size: 35px; text-align: left; line-height: 50px; white-space: nowrap;">Календарь отпусков на {{year}}</a>
    <div style="display: flex; flex-direction: row; align-items: center; margin-left: 20px; gap: 20px; flex-grow: 1; justify-content: flex-end;">
        <div class="flex-container">
			<button id="filter-toggle" type="button" class="filter-button">
				Фильтр
			</button>

			<div id="filter-panel" class="filter-panel">
				<div class="filter-field">
					<label for="filter_otd" class="filter-label" style="margin-bottom: -6px;">Отдел</label>
					<select id="filter_otd" name="filter_otd" class="filter-select">
						{% if request.user.is_superuser or is_supervisor %}
							<option value="0" {% if otd == 0 %}selected{% endif %}>Все отделы</option>
							{% for o in otds_for_choise %}
								<option value="{{ o }}" {% if o == otd %}selected{% endif %}>{{ o }}</option>
							{% endfor %}
						{% else %}
							{% if current_dept_label %}
								<option value="{{ current_dept_label }}" selected>{{ current_dept_label }}</option>
							{% endif %}
						{% endif %}
					</select>
				</div>

				<div class="filter-field">
					<label for="filter_tags" class="filter-label" style="margin-bottom: -2px;">Тег</label>
					<select id="filter_tags" name="filter_tags" multiple="multiple" class="filter-select-multi">
						{% for tag in all_tags %}
							<option value="{{ tag.name }}" {% if tag.name in selected_tags %}selected{% endif %}>
								{{ tag.name }}
							</option>
						{% endfor %}
					</select>
				</div>

				<div class="filter-footer">
					<button type="button" onclick="applyFilters()" class="filter-apply-button">
						Показать
					</button>
				</div>
			</div>

			<select id="filtr_year" name="filtr_year" style="font-size: 18px; padding: 5px 10px; border: 1px solid #5d6778; color: #5d6778; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; width: 140px; height: 35px; cursor: pointer;" onchange="updateFilters()">
				<option value="0" disabled selected>Год</option>
				{% for y in years_range %}
					<option value="{{ y }}">{{ y }}</option>
				{% endfor %}
			</select>

			{% if request.user.get_full_name in bosses %}
			<a href="{% url 'import_vacations' %}" id="import_link" style="display: inline-block; text-align: center; font-size: 18px; padding: 5px 15px; border: 1px solid #5d6778; border-radius: 3px; background-color: white; color: #5d6778; width: 140px; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; height: 35px; cursor: pointer; text-decoration: none;">
				Импорт
			</a>
			<a href="{% url 'export_vacations' year otd %}" id="export_link" style="display: inline-block; text-align: center; font-size: 18px; padding: 5px 15px; border: 1px solid #5d6778; border-radius: 3px; background-color: white; color: #5d6778; width: 140px; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; height: 35px; cursor: pointer; text-decoration: none;">
				Экспорт
			</a>
			{% endif %}
		</div>
    </div>
</div>

<div style="display: flex; flex-wrap: wrap; white-space: normal; flex-direction: row; justify-content: left; align-items: center; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; font-size: 18px; color: #5d6778;">
    Параметры фильтрации:
    отдел&nbsp;<span style="color: #20c997;">{% if otd == 0 %}Все отделы{% else %}{{ otd }}{% endif %}</span>,
    год&nbsp;<span style="color: #20c997;">{{ year }}</span>
    {% if selected_tags %}
        , теги&nbsp;
        {% for tag in selected_tags %}
            <span style="color: #20c997;">{{ tag }}</span>{% if not forloop.last %},&nbsp;{% endif %}
        {% endfor %}
    {% endif %}

    {% if otd != 0 and request.user.get_full_name in bosses or selected_tags %}
        <span style="margin-left: 0.5rem;">
            <a class="darker" href="{% url 'vac_2' year=year otd=0 %}">
                Сбросить все фильтры
            </a>
        </span>
    {% endif %}
</div>

<script>
	var currentYear = "{{ year }}";
	var currentOtd = "{{ otd }}";

	document.addEventListener('DOMContentLoaded', function() {
		var deptSelect = document.getElementById('filter_otd');
		if (deptSelect) {
			deptSelect.value = currentOtd;
		}
	});
	
	document.getElementById('filter-toggle').addEventListener('click', function() {
        const panel = document.getElementById('filter-panel');
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    });

	document.addEventListener('click', function(event) {
        var panel = document.getElementById('filter-panel');
        var btn   = document.getElementById('filter-toggle');
        if (!panel.contains(event.target) && !btn.contains(event.target)) {
            panel.style.display = 'none';
        }
    });
	
	function updateFilters() {
        var selectedYear = document.getElementById('filtr_year').value;
        if (!selectedYear || selectedYear === "0") {
            alert('Пожалуйста, выберите год.');
            return;
        }

        // Собираем выбранные теги
        var tagsSelect = document.getElementById('filter_tags');
        var selectedTags = [];
        for (var i = 0; i < tagsSelect.options.length; i++) {
            var opt = tagsSelect.options[i];
            if (opt.selected) {
                selectedTags.push(opt.value.trim());
            }
        }
        var tagsParam = selectedTags.join(',');
        
        var newUrl = "{% url 'vac_2' 0 0 %}".replace("0/0", selectedYear + "/" + currentOtd);
        
        if (tagsParam) {
            newUrl += "?tags=" + encodeURIComponent(tagsParam);
        }
        
        window.location.href = newUrl;
    }

	function applyFilters() {
        var year = currentYear;
        var selectedDept = document.getElementById('filter_otd').value;
        var tagsSelect = document.getElementById('filter_tags');
        var selectedTags = [];

        for (var i = 0; i < tagsSelect.options.length; i++) {
            var opt = tagsSelect.options[i];
            if (opt.selected) {
                selectedTags.push(opt.value.trim());
            }
        }
        var tagsParam = selectedTags.join(',');

        var targetUrl = "{% url 'vac_2' 0 0 %}".replace("0/0", year + "/" + selectedDept);
        if (tagsParam) {
            targetUrl += "?tags=" + encodeURIComponent(tagsParam);
        }
        window.location.href = targetUrl;
    }

	$('#filter_tags').select2({
		placeholder: 'Все теги',
		width: '100%',
	});
</script>
{% endblock %}

{% block aside %}
    {% include 'includes/aside_vac_new.html' %}
{% endblock %}

{% block content %}
<style>
	.flex-container {
		position: relative;
		display: flex;
		flex-direction: row;
		justify-content: flex-start;
		align-items: center;
		gap: 20px;
		width: 100%;
	}

	.filter-button {
		font-size: 18px;
		padding: 5px 10px;
		border: 1px solid #5d6778;
		background-color: white;
		color: #5d6778;
		cursor: pointer;
		border-radius: 3px;
		text-transform: none;
		width: 140px;
		height: 35px;
		font-family: 'Calibri'; 
		font-style: normal;
		font-weight: 400;
		line-height: 22px;
		margin-top: 1px;
		background-image: url("{% static 'funnel.svg' %}"), url("{% static 'arrow-drop.svg' %}");
		background-position: left 10px center, right 5px center;
		background-repeat: no-repeat, no-repeat;
		background-size: 20px 20px, 20px 20px;
		padding-left: 10px;
		padding-right: 3px;
	}

	.filter-button:hover,
	.filter-button:focus {
		background-image: url("{% static 'funnel.svg' %}"), url("{% static 'arrow-drop.svg' %}");
		background-position: left 10px center, right 5px center;
		background-repeat: no-repeat, no-repeat;
		background-size: 20px 20px, 20px 20px;
		padding-left: 10px;
		padding-right: 3px;
		background-color: white;
		border-color: #5d6778;
		color: #5d6778;
		box-shadow: none;
		outline: none;
	}

	.filter-panel {
		display: none;
		position: absolute;
		top: 105%;
		left: 0;
		width: 250px;
		background-color: #ffffff;
		border: 1px solid #ced4da;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
		border-radius: 4px;
		z-index: 1000;
		padding: 8px 12px;
	}

	.filter-field {
		margin-bottom: 10px;
	}

	.filter-label {
		display: block;
		font-size: 15px;
		color: #5d6778;
		font-weight: 500;
	}

	.filter-select {
		width: 100%;
		font-size: 14px;
		padding: 4px 6px;
		border: 1px solid #ced4da;
		border-radius: 3px;
		color: #5d6778;
		text-align: left;
		background-color: white;
		height: 35px;
		font-family: 'Calibri', sans-serif;
		font-weight: normal;
	}

	.filter-select-multi {
		width: 100%;
		font-size: 14px;
		padding: 4px 6px;
		border: 1px solid #ced4da;
		border-radius: 3px;
		color: #5d6778;
		background-color: white;
		font-family: 'Calibri', sans-serif;
	}

	.filter-footer {
		text-align: left;
		margin-top: -14px;
	}

	.filter-apply-button {
		font-size: 14px;
		padding: 5px 12px;
		border: 1px solid #bcc1cb;
		background-color: white;
		color: #5d6778;
		cursor: pointer;
		border-radius: 4px;
		text-transform: none;
		font-weight: 500;
		width: 106px;
		height: 33px;
		font-family: 'Calibri', sans-serif;
	}

	.filter-apply-button:hover,
	.filter-apply-button :focus {
		background-color: white;
		border-color: #15a362;
		color: #15a362;
		box-shadow: none;
		outline: none;
	}

	.select2-container--default .select2-selection--multiple {
		height: auto;
		min-height: 35px;
		padding: 2px 4px;
		display: flex;
		flex-wrap: wrap;
		align-items: center;
		font-size: 14px;
		max-height: 120px;
    	overflow-y: auto;
		overflow-x: hidden;
	}

	.select2-container--default .select2-selection--multiple .select2-selection__rendered {
		display: flex;
		flex-wrap: wrap;
		align-items: center;
		margin: 0;
		padding: 0;
	}

	.select2-container--default .select2-selection--multiple .select2-selection__choice {
		max-width: 220px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		display: inline-block;
		background: transparent;
		border: none;
		color: #5d6778;
		padding: 0;
		margin: 6px 4px 2px 0;
		font-weight: normal;
	}

	.select2-container--default .select2-selection--multiple .select2-selection__choice::after {
        content: ",";
        margin-left: -6px;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice:last-child::after {
        content: "";
    }

	.darker { 
		color: #20c997;
		font-size: 17px; 
		text-decoration: underline; 
	}

    .darker:hover { 
		color: #15a362; 
	}
	
	#filtr_year {
		background-image: url("{% static 'calendar.svg' %}"), url("{% static 'arrow-drop.svg' %}");
		background-position: left 10px center, right 5px center;
		background-repeat: no-repeat, no-repeat;
		background-size: 20px 20px, 20px 20px;
		padding-left: 10px;  
		padding-right: 3px; 
	}

	#import_link {
		background-image: url("{% static 'box-arrow-in-down-svgrepo.svg' %}");
		background-position: left 10px center;
		background-repeat: no-repeat;
		background-size: 20px 20px;
	}

	#export_link {
		background-image: url("{% static 'printer.svg' %}");
		background-position: left 10px center;
		background-repeat: no-repeat;
		background-size: 20px 20px;
	}

	#tooltip {
		position: absolute;
		background-color: rgba(0, 0, 0, 0.8);  
		color: white;  
		padding: 10px; 
		border-radius: 5px;  
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);  
		display: none;  
		z-index: 1000;  
	}

	.swal2-title {
		font-size: 24px; 
		color: #000000;
		text-align: left;
	}

	.table {
		font-size: 19px; 
	}

	@keyframes slideInTop {
	from {
		transform: translateY(-100%);
		opacity: 0;
	}
	to {
		transform: translateY(0);
		opacity: 1;
	}
	}

	@keyframes slideOutTop {
	from {
		transform: translateY(0);
		opacity: 1;
	}
	to {
		transform: translateY(-100%);
		opacity: 0;
	}
	}

	.custom-popup {
		min-width: 800px;
		width: auto;
		top: 60px; 
		position: fixed; 
		animation: slideInTop 0.5s ease-out;
	}

	.custom-popup.swal2-hide,
	.my-add-vacation-modal.swal2-hide {
		animation: slideOutTop 0.5s ease-in forwards;
	}

	.ellipsis-cell {
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis;
		max-width: 300px;
		display: inline-block;
		vertical-align: middle;
	}

	.my-add-vacation-modal {
		top: 60px; 
		position: fixed; 
		animation: slideInTop 0.5s ease-out;
	}

	.my-add-vacation-modal .swal2-title {
		margin-bottom: 10px;
	}

	.my-add-vacation-modal .swal2-input {
		width: 100% !important;
		margin: 5px 0 !important;
	}

	:root {
		--text-color: #5d6778;
		--field-height: 40px;
		--gap: 10px;
		--row-gap: 8px;
	}

	/* Общий цвет текста и полей */
	.my-add-vacation-modal .swal2-html-container,
	.my-add-vacation-modal .swal2-html-container label,
	.my-add-vacation-modal .swal2-html-container input,
	.vacation-form .dates-grid input[type="date"] {
		color: var(--text-color);
	}

	/* Сетка для строки «Сотрудник» */
	.vacation-form .employee-grid {
		display: grid;
		grid-template-columns: 120px 1fr;
		column-gap: var(--gap);
		align-items: center;
		margin-bottom: 12px;
	}
	.vacation-form .label-cell {
		display: flex;
		align-items: center;
		font-weight: 500;
	}
	.vacation-form select {
		width: 100%;
		box-sizing: border-box;
		padding: 4px 8px;
		height: var(--field-height);
		text-align: left;
		font-weight: normal;
	}

	/* Заголовки дат */
	.vacation-form .dates-header {
		display: grid;
		grid-template-columns: 120px 1fr 0.6fr 1fr auto;
		column-gap: var(--gap);
		margin-bottom: 10px;
		align-items: center;
	}
	.vacation-form .dates-header .date-header {
		font-size: 0.9em;
		font-weight: 400;
		justify-self: center;
	}

	.vacation-form .dates-header > div:nth-child(2) {
		margin-right: 10px;
	}
	.vacation-form .dates-header > div:nth-child(3) {
		margin-right: 23px;
	}
	.vacation-form .dates-header > div:nth-child(4) {
		margin-right: 30px;
	}
	
	/* Сетка для полей дат */
	.vacation-form .dates-grid {
		display: grid;
		grid-template-columns: 120px 1fr 0.6fr 1fr auto;
		column-gap: var(--gap);
		row-gap: var(--row-gap);
		margin-bottom: 12px;
		align-items: center;
	}
	.vacation-form .dates-grid input[type="text"],
	.vacation-form .dates-grid input[type="number"] {
		width: 100%;
		max-width: 200px;
		height: var(--field-height);
		padding: 4px 8px;
		box-sizing: border-box;
		font-size: 0.9em;
	}
	.vacation-form .delete-row {
		cursor: pointer;
		height: 20px;
	}

	#add-vacation-button {
		display: flex;
  		align-items: center;
		width: 160px;
		background-color: white;
		color: #5d6778;
		border: 1px solid #5d6778;
		border-radius: 5px;
		font-size: 16px;
		text-transform: none;
		cursor: pointer;
	}

	#add-vacation-button:focus {
		outline: none;
		box-shadow: none;
	}

	#add-vacation-button .button-icon {
		width: 16px;
		height: 16px;
		margin-left: 5px;
		margin-right: 7px;
		margin-bottom: 0;
	}

	.my-add-vacation-modal .swal2-actions {
		display: flex;
		justify-content: flex-start;
		gap: 20px;
		margin-top: 0;
		margin-left: 29px;
	}

	.swal-confirm-btn {
		width: 260px;
		background-color: #15a362;
		color: white;
		text-transform: none;
		border: none;
		border-radius: 5px;
		font-size: 16px;
		cursor: pointer;
	}

	.swal-cancel-btn {
		width: 120px;
		background-color: white;
		border-radius: 5px;
		color: #5d6778;
		border: 1px solid #5d6778;
		text-transform: none;
		font-size: 16px;
		cursor: pointer;
	}

	.swal-cancel-btn:hover {
		background-color: white;
		color: #5d6778;
		border: 1px solid #5d6778;
		box-shadow: none;
		outline: none;
	}

	.tooltip-wrapper {
		position: relative;
		display: inline-block;
		cursor: pointer;
	}

	.tooltip-wrapper .tooltip-icon {
		width: 18px;
		height: 18px;
		object-fit: contain;
	}

	.tooltip-wrapper::before {
		content: attr(data-tooltip);
		position: absolute;
		bottom: calc(100% + 6px);
		left: 50%;
		transform: translateX(-50%);
		width: 200px;          
		background: rgba(0, 0, 0, 0.9);
		color: #fff;
		padding: 6px 8px;
		border-radius: 4px;
		font-size: 0.8em;
		line-height: 1.2;
		opacity: 0;
		pointer-events: none;
		transition: opacity 0.15s ease-in-out;
		z-index: 1000;
	}

	.tooltip-wrapper::after {
		content: "";
		position: absolute;
		bottom: calc(100% - 4px);
		left: 50%;
		transform: translateX(-50%);
		border-width: 5px;
		border-style: solid;
		border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
		opacity: 0;
		transition: opacity 0.15s ease-in-out;
		z-index: 1000;
	}

	.tooltip-wrapper:hover::before,
	.tooltip-wrapper:hover::after {
		opacity: 1;
	}

	.swal2-input:focus { 
		border-color: #0d6efd; 
		outline: none;
		box-shadow: none;
	}

	.my-swal-popup {
		border-radius: 12px;
		box-shadow: 0 8px 20px rgba(0,0,0,0.1);
		padding: 1.2rem;
		margin-top: -200px !important;
	}

	.my-swal-title-success {
		color: #15a362;
		font-size: 22px;
		margin-bottom: 0.4rem;
		text-align: center !important;
	}

	.my-swal-title-error {
		color: #c0392b;
		font-size: 22px;
		margin-bottom: 0.4rem;
		text-align: center !important;
	}

	.my-swal-content {
		font-size: 17px;
		color: #5d6778;
	}

	.my-swal-button-success,
	.my-swal-button-error {
		color: #fff !important;
		border-radius: 8px;
		padding: 0.5rem 1.2rem;
		font-size: 17px;
		text-transform: none;
		outline: none !important;
	}

	.my-swal-button-success {
		background-color: #15a362 !important;
	}

	.my-swal-button-error {
		background-color: #c0392b !important;
	}

	.my-swal-button-success:active,
	.my-swal-button-error:active {
		outline: none !important;
		box-shadow: none !important;
		filter: brightness(1.0) !important;
	}

	.my-swal-button-success:hover,
	.my-swal-button-error:hover {
		filter: brightness(1.2);
	}

	.vac-tags {
		display: flex;
		flex-wrap: wrap;
		align-items: flex-start;
		gap: 4px 8px;
		margin-top: 6px;
	}

	.vac-tags span {
		display: inline-block;
		background-color: #5b99ea;
		color: white;
		border-radius: 5px;
		padding: 2px 6px;
		font-size: 0.7em;
		white-space: nowrap;
		font-weight: 500;
	}

	.vacation-cell th,
	.vacation-cell td {
		padding-bottom: 7px;
		padding-top: 7px;
		vertical-align: top;
	}

	table th:nth-child(3),
	table td:nth-child(3) {
		padding-right: 20px;
	}

	.select--disabled {
		background-color: #f5f5f5;
		color: black;
		cursor: default;
	}

	.swal2-confirm:focus,
	.swal2-confirm:focus-visible {
		outline: none !important;
		box-shadow: none !important;
	}
</style>
<div style="width: 110%; display: flex; flex-direction: row;">
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Январь" value=Январь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Февраль" value=Февраль %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Март" value=Март %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Апрель" value=Апрель %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Май" value=Май %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Июнь" value=Июнь %}</div>
</div>

<div style="width: 110%; display: flex; flex-direction: row;">
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Июль" value=Июль %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Август" value=Август %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Сентябрь" value=Сентябрь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Октябрь" value=Октябрь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Ноябрь" value=Ноябрь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Декабрь" value=Декабрь %}</div>
</div>
{% if len_cross_vacations > 0 %}
<div style="width: 110%; display: flex; flex-direction: row; margin-top: 15px;">
	<div style="background:linear-gradient(135deg, #df691a 22.22%, #4e5d6c 22.22%, #4e5d6c 50%, #df691a 50%, #df691a 72.22%, #4e5d6c 72.22%, #4e5d6c 100%);
	width: 80px; height: 20px;">
	</div>
	<a>&nbsp;- дни с пересекающимися отпусками от 2 сотрудников.</a>
</div>
{% endif %}
<div id="tooltip"></div>
<div style="width: 110%; display: flex; flex-direction: row; margin-top: 15px;">
	<table style="width: 900px;">
		<tr style="border-bottom: 1px solid black;">
			<th style="text-align: left;">Сотрудник</th><th>Отдел</th><th>Дней</th>
		</tr>

		{% for key, value in vacations_by_user.items %}
			<tr style="border-bottom: 1px solid rgb(187, 185, 185); height: 40px;"
				class="vacation-cell" 
				data-employee-name="{{key}}"
				data-start-date="{% for start_date, days_count in value.vacation_start_dates %}{{start_date}}{% if not forloop.last %}, {% endif %}{% endfor %}" 
				data-end-date="{% for end_date in value.vacation_end_dates %}{{end_date}}{% if not forloop.last %}, {% endif %}{% endfor %}"
				data-vac-id="{% for vac in value.dates %}{{ vac.vac_id }}{% if not forloop.last %}, {% endif %}{% endfor %}">
				<th style="text-align: left;">
					<div style="display: flex; flex-direction: row; justify-content: left; align-items: center;">
						<div style="width: 15px; height: 15px; background: {{value.color}}; border: 1px solid black; margin-right: 6px;"></div>
						<a style="color: black" href="#" onclick="filtrByUser(this)">{{value.user.get_full_name}}</a>
					</div>

					{% for ui in employees %}
						{% if ui.user.id == value.user_id %}
							{% if ui.tags.all %}
								<div class="vac-tags">
									{% for tag in ui.tags.all %}
									<span class="tag">{{ tag.name }}</span>
									{% endfor %}
								</div>
							{% endif %}
						{% endif %}
					{% endfor %}
				</th>
				<th>{{value.otd }}</th>
				<th>{{value.sum }}</th>
			</tr>
		{% endfor %}
	</table>
	<div style="border: 1px solid rgb(187, 185, 185); padding: 5px;">
		<div id="vacation-message">В данный момент нет сотрудников в отпуске.</div>
		<div id="info" style="margin-top: 20px; border: 1px solid rgb(187, 185, 185);"></div>
	</div>
</div>

<script>
	if (window.history.replaceState) {
		window.history.replaceState(null, null, window.location.href);
	}

	let data = JSON.parse("{{json_data|escapejs}}");
	let vacs = JSON.parse("{{json_data_vacs|escapejs}}");
	const bosses = JSON.parse('{{ bosses_list|escapejs }}');
	const currentUser = "{{ current_user_name|escapejs }}";
	const user_names = JSON.parse('{{ user_names|escapejs }}');

	// Универсальные массивы и объекты месяцев
	const monthNames = [
		"", "января", "февраля", "марта", "апреля", "мая", "июня",
		"июля", "августа", "сентября", "октября", "ноября", "декабря"
	];
	const fullMonthNames = [
		"Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
		"Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
	];
	const monthToNumber = {
		"Январь": "01", "Февраль": "02", "Март": "03", "Апрель": "04",
		"Май": "05", "Июнь": "06", "Июль": "07", "Август": "08",
		"Сентябрь": "09", "Октябрь": "10", "Ноябрь": "11", "Декабрь": "12"
	};

	function isBoss(userName) {
		return bosses.includes(userName);
	}

	function getMonthName(monthNumber) {
		return monthNames[parseInt(monthNumber)];
	}

	function getMonthLabel(month) {
		return (month === "Март" || month === "Август")
			? month + 'а'
			: month.substring(0, month.length - 1) + 'я';
	}

	function showCrossData(obj) {
		let [month, week, day] = obj.id.split('_');
		day = Number(day);
		let info = document.getElementById('info');
		let messageDiv = info.previousElementSibling;

		let month_for_lbl = getMonthLabel(month);
		let innerHtml = data[month][week][day]["name"] + ' ' + month_for_lbl + ' {{year}}';

		if (Object.keys(data[month][week][day]['date']).length > 0) {
			for (const [user_id, v] of Object.entries(data[month][week][day]['date'])) {
				let [first_date, second_date] = v['date'].split(' - ');
				let [day1, month1] = first_date.split('-').reverse();
				let [day2, month2] = second_date.split('-').reverse();
				let period = `${day1} ${getMonthName(month1)} - ${day2} ${getMonthName(month2)}`;
				let user_name = user_names[user_id] || "Неизвестный пользователь";

				innerHtml += `
					<div style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
						<div style="width: 15px; height: 15px; background: ${v['color']}; border: 1px solid black; margin-right: 6px;"></div>
						<div>${user_name}</div>
					</div>
					<div>${period}</div>`;
			}
			messageDiv.innerText = "В данный момент есть сотрудники в отпуске:";
			info.style.display = "block";
		} else {
			info.innerHTML = '';
			info.style.display = "none";
			messageDiv.innerText = "В данный момент нет сотрудников в отпуске.";
		}
		info.innerHTML = innerHtml;
	}

	document.addEventListener("DOMContentLoaded", function () {
		// Год, переданный сервером
		const selectedYear = parseInt("{{ year }}", 10);
		// Фактический текущий год
		const nowDate = new Date();
		const jsYear  = nowDate.getFullYear();

		if (jsYear !== selectedYear) {
			const messageDiv = document.getElementById("vacation-message");
			messageDiv.innerText = "В данный момент нет сотрудников в отпуске.";
			const info = document.getElementById("info");
			info.innerHTML = "";
			info.style.display = "none";
			return;
		}
		
		const currentDay   = nowDate.getDate();
    	const currentMonth = nowDate.getMonth();
		const firstOfMonth = new Date(jsYear, currentMonth, 1);
		const firstWeekday = firstOfMonth.getDay() === 0 ? 6 : firstOfMonth.getDay() - 1;
		const todayWeekday = nowDate.getDay() === 0 ? 6 : nowDate.getDay() - 1;
		const weekOffset = Math.floor((currentDay + firstWeekday - 1) / 7) + 1;

		const monthLabel = fullMonthNames[currentMonth];
    	const currentId  = `${monthLabel}_${weekOffset}_${todayWeekday}`;
		
		const currentDayElement = document.getElementById(currentId);
		if (currentDayElement) {
			showCrossData(currentDayElement);
		} else {
			const messageDiv = document.getElementById("vacation-message");
			messageDiv.innerText = "В данный момент нет сотрудников в отпуске.";
			const info = document.getElementById("info");
			info.innerHTML = "";
			info.style.display = "none";
		}
	});

	function getEmployeeDepartment(employeeName) {
		let rows = document.querySelectorAll(".vacation-cell");
		for (let row of rows) {
			if (row.getAttribute("data-employee-name").trim() === employeeName.trim()) {
				return row.querySelector("th:nth-child(2)").innerText.trim();
			}
		}
		return "Отдел не указан";
	}

	function showCalendarPopup(obj) {
		let [month, week, dayIndex] = obj.id.split('_');
		dayIndex = Number(dayIndex);
		let day = data[month][week][dayIndex]?.name || dayIndex;
		let month_for_lbl = getMonthLabel(month).toLowerCase();
		const year = "{{year}}";
		let title = `Отпуска на ${day} ${month_for_lbl} ${year}`;
		let monthNumber = monthToNumber[month] || "00";
		let formattedDay = day < 10 ? `0${day}` : day;
		let formattedDate = `${formattedDay}.${monthNumber}.${year}`;

		let vacationData = [];
		if (Object.keys(data[month][week][dayIndex]['date']).length > 0) {
			for (const [user_id, info] of Object.entries(data[month][week][dayIndex]['date'])) {
				let user_name = user_names[user_id] || "Неизвестный пользователь";
				let period = formatVacationPeriod(info['date']);
				let department = getEmployeeDepartment(user_id);
				vacationData.push({ user_id: user_id, name: user_name, period, department, color: info['color'], vac_id: info['vac_id'] });
			}
		}

		let content = '';
		if (vacationData.length > 0) {
			content += `<table class="table" style="width: 100%;">
				<thead>
					<tr>
						<th>Сотрудник</th>
						<th>Отдел</th>
						<th>Период</th>
					</tr>
				</thead>
				<tbody>`;
			for (let entry of vacationData) {
				const profileUrl = `/users/profile/${entry.user_id}/`;
				const editUrl = `/users/vacations/vacation_edit/${year}/${entry.vac_id}/?from=calendars`;
				content += `<tr>
					<td>
						<div style="display: flex; align-items: center;">
							<div style="width: 15px; height: 15px; background: ${entry.color}; border: 1px solid black; margin-right: 6px;"></div>
							<a href="${profileUrl}" class="ellipsis-cell" style="color: #15a362;" title="${entry.name}">${entry.name}</a>
						</div>
					</td>
					<td><span class="ellipsis-cell" title="${entry.department}">${entry.department}</span></td>
					<td>
						<span class="ellipsis-cell" title="${entry.period}" style="font-style: italic; ${isBoss(currentUser) || currentUser === entry.name ? 'text-decoration: underline; color: #15a362;' : 'color: black;'}">
							${isBoss(currentUser) || currentUser === entry.name ? `<a href="${editUrl}" style="color: inherit; text-decoration: inherit;">${entry.period}</a>` : entry.period}
						</span>
					</td>
				</tr>`;
			}
			content += `</tbody></table>`;
		} else {
			content = `<div style="font-size: 22px;">Не найдено отпусков за <strong>${formattedDate}</strong></div>`;
		}

		title += `<span style="background-color: #5b99ea; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">${vacationData.length} чел.</span>`;
		
		const wrapped = `<div style="text-align: left;">${content}</div>`;
		
		Swal.fire({
			title: `<div>${title}</div>`,
			html: wrapped,
			showCloseButton: true,
			showConfirmButton: false,
			customClass: {
				popup: 'custom-popup'
			}
		});

		const closeButton = document.querySelector('.swal2-close');
		if (closeButton) {
			closeButton.style.outline = 'none';
		}
	}

	function formatVacationPeriod(dateRange) {
		let [start, end] = dateRange.split(' - ');
		let [day1, month1] = start.split('-').reverse();
		let [day2, month2] = end.split('-').reverse();
		return `${day1} ${getMonthName(month1)} - ${day2} ${getMonthName(month2)}`;
	}

	let tooltipTimeout;

	function startTooltipTimeout(event, month, week, day) {
		clearTimeout(tooltipTimeout);
		tooltipTimeout = setTimeout(() => {
			if (data[month]?.[week]?.[day]?.['date'] && Object.keys(data[month][week][day]['date']).length > 0) {
				showTooltip(event, month, week, day);
			}
		}, 400);
	}

	function clearTooltipTimeout() {
		clearTimeout(tooltipTimeout);
		hideTooltip();
	}

	function showTooltip(event, month, week, day) {
		let tooltip = document.getElementById('tooltip');
		if (data[month][week][day] && Object.keys(data[month][week][day]['date']).length > 0) {
			let tooltipContent = '';
			for (const [user_id, v] of Object.entries(data[month][week][day]['date'])) {
				let [start, end] = v['date'].split(' - ');
				let [day1, month1] = start.split('-').reverse();
				let [day2, month2] = end.split('-').reverse();
				let user_name = user_names[user_id] || "Неизвестный пользователь";

				tooltipContent += `<div style="color: ${v['color']};">${user_name}</div>
					<div>${day1} ${getMonthName(month1)} - ${day2} ${getMonthName(month2)}</div>`;
			}
			tooltip.innerHTML = tooltipContent;
			tooltip.style.display = 'block';
			tooltip.style.left = event.pageX + 'px';
			tooltip.style.top = (event.pageY - tooltip.offsetHeight - 12) + 'px';
		} else {
			hideTooltip();
		}
	}

	function hideTooltip() {
		let tooltip = document.getElementById('tooltip');
		tooltip.style.display = 'none';
		tooltip.innerHTML = '';
	}

	function filtrByUser(obj) {
		let row = obj.closest('tr');
		let employeeId = row.getAttribute('data-employee-name');
		let days = document.getElementsByName('day');

		let colorElement = row.querySelector('div[style*="background:"]');
    	let employeeColor = colorElement ? colorElement.style.background : '#df691a';

		for (let i = 0; i < days.length; i++) {
			let [month, week, day] = days[i].id.split('_');
			if (data[month][week][day]) {
				for (const [k, v] of Object.entries(data[month][week][day]['data'])) {
					if (k !== employeeId) {
						days[i].childNodes[1].style.background = (day == 5 || day == 6)
							? 'rgb(219, 219, 219)'
							: 'transparent';
						days[i].childNodes[1].style.color = '#808080';
					} else {
						days[i].childNodes[1].style.background = employeeColor;
						days[i].childNodes[1].style.color = 'white';
						days[i].childNodes[1].style.backgroundSize = '28px 28px';
						days[i].childNodes[1].style.backgroundPosition = 'center';
						days[i].childNodes[1].style.backgroundRepeat = 'no-repeat';
						break;
					}
				}
			}
		}
	}

	const modalHolidays = JSON.parse('{{ holidays_json|escapejs }}');
	let vacationCounter = 1;

	function calculateEndDate(startISO, daysCount) {
		let date = new Date(startISO);
		let remaining = parseInt(daysCount, 10);
		if (isNaN(remaining) || remaining < 1) return startISO;

		while (remaining > 0) {
			date.setDate(date.getDate() + 1);

			const weekday = date.getDay();          
			const monthName = fullMonthNames[date.getMonth()];
			const dayNum = date.getDate();

			const isWeekend = (weekday === 0 || weekday === 6);
			const isHoliday = Array.isArray(modalHolidays[monthName]) &&
							modalHolidays[monthName].includes(dayNum);

			if (!isWeekend && !isHoliday) {
			remaining--;
			}
		}

		const y = date.getFullYear();
		const m = monthToNumber[monthName] || String(date.getMonth()+1).padStart(2,'0');
		const d = String(dayNum).padStart(2, '0');
		return `${y}-${m}-${d}`;
	}

	function openAddVacationModal(userId, userName) {
		const initialContent = `
			<div class="vacation-form">
			<div class="employee-grid">
				<div class="label-cell required">
				<label for="vacation-employee">Сотрудник<span style="color: red;">&nbsp;*</span></label>
				</div>
				<select
					id="vacation-employee"
					class="swal2-input"
					style="
						white-space: nowrap;
						overflow: hidden;
						text-overflow: ellipsis;
						width: 100%;
					"
					>
					{% for emp in employees %}
						<option value="{{ emp.user.id }}" style="white-space: nowrap;">
						{{ emp.user.get_full_name }}
						{% if emp.position %} ({{ emp.position.position }}){% endif %}
						</option>
					{% endfor %}
				</select>
			</div>

			<div class="dates-header">
				<div style="width: 120px;"></div>
				<div class="date-header">Дата начала<span style="color: red;">&nbsp;*</span></div>
				<div class="date-header">
					Дней
					<span class="tooltip-wrapper" data-tooltip="Укажите количество календарных дней и дата окончания рассчитается автоматически.">
						<img
						src="{% static 'question.svg' %}"
						alt="info"
						class="tooltip-icon"
						aria-hidden="true"
						>
					</span>
				</div>
				<div class="date-header">Дата окончания<span style="color: red;">&nbsp;*</span></div>
				<div style="width: auto;"></div>
			</div>
			
			<div class="dates-grid">
				<div class="label-cell vacation-row-1">Отпуск:</div>
				<input type="text" class="swal2-input start-date vacation-row-1" required placeholder="дд.мм.гггг">
				<input type="number" min="1" class="swal2-input days-count vacation-row-1" placeholder="0"
				>
				<input type="text" class="swal2-input end-date vacation-row-1" required placeholder="дд.мм.гггг">
				<img src="{% static 'delete.svg' %}" class="delete-row vacation-row-1" onclick="removeVacationRow(1)">
			</div>

			<button type="button" id="add-vacation-button" onclick="addVacationRow()" style="margin-top: 10px;">
				<img src="{% static 'plus-circle.svg' %}" class="button-icon">
				Еще отпуск
			</button>
			</div>
		`;

		Swal.fire({
			title: 'Добавление отпуска',
			html: initialContent,
			width: '650px',
			customClass: { 
				popup: 'my-add-vacation-modal',
				confirmButton: 'swal-confirm-btn',
				cancelButton: 'swal-cancel-btn'
			},
			showCancelButton: true,
			showCloseButton: true,
			reverseButtons: true,
			buttonsStyling: false,
			didOpen: () => {
				const popup = Swal.getPopup();
				const select = popup.querySelector('#vacation-employee');
				
				for (let opt of select.options) {
					if (opt.value === userId) {
						opt.selected = true;
						break;
					}
				}

				if (isBoss(currentUser)) {
					select.disabled = false;
					select.style.cursor = 'pointer';
				} else {
					select.disabled = true;
					select.classList.add('select--disabled');
				}

				// Настройка flatpickr
				const initFlatpickr = (element, onChangeCallback) => {
					const fpConfig = {
						dateFormat: "Y-m-d",
						altInput: true,
        				altFormat: "d.m.Y",
						minDate: new Date(currentYear, 0, 1),
						maxDate: new Date(currentYear, 11, 31),
						locale: 'ru',
						allowInput: true,
						disableMobile: true,
						static: false,
						position: "auto",
						appendTo: document.body,
						onOpen: () => {
							// Дополнительные корректировки при открытии
							const calendar = document.querySelector('.flatpickr-calendar');
							if (calendar) {
								calendar.style.zIndex = 99999;
								calendar.style.position = 'fixed';
							}
						}
					};
					
					if (onChangeCallback) {
						fpConfig.onChange = onChangeCallback;
					}
					
					return flatpickr(element, fpConfig);
				};

				const closeBtn = Swal.getCloseButton();
				if (closeBtn) {
					closeBtn.setAttribute('tabindex', '-1');
					closeBtn.blur();
				}

				if (document.activeElement) {
				document.activeElement.blur();
				}

				// Функция для получения реального значения даты из flatpickr
				function getRealDateValueFromInput(input) {
					if (input._flatpickr) {
						if (input._flatpickr.selectedDates.length > 0) {
							return input._flatpickr.formatDate(input._flatpickr.selectedDates[0], 'Y-m-d');
						}
						if (input._flatpickr.input) {
							const realValue = input._flatpickr.input.value;
							if (realValue) return realValue;
						}
					}
					let value = input.value;
					if (value && value.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
						const [d, m, y] = value.split('.');
						return `${y}-${m}-${d}`;
					}
					return value;
				}

				// Функция для расчета количества рабочих дней между двумя датами
				function calculateWorkingDays(startDateStr, endDateStr) {
					if (!startDateStr || !endDateStr) {
						return 0;
					}

					const startDateParts = startDateStr.split('-');
					const endDateParts = endDateStr.split('-');

					if (startDateParts.length !== 3 || endDateParts.length !== 3) {
						return 0;
					}

					// Устанавливаем даты с нулевым временем для точности
					let currentDate = new Date(Date.UTC(startDateParts[0], startDateParts[1] - 1, startDateParts[2]));
					const endDate = new Date(Date.UTC(endDateParts[0], endDateParts[1] - 1, endDateParts[2]));

					if (currentDate > endDate) {
						return 0;
					}

					let workingDays = 0;

					while (currentDate <= endDate) {
						const mName = fullMonthNames[currentDate.getUTCMonth()];
						const dNum = currentDate.getUTCDate();
						const monthHolidays = Array.isArray(modalHolidays[mName]) ? modalHolidays[mName] : [];

						// Если день не является праздником, учитываем его
						if (!monthHolidays.includes(dNum)) {
							workingDays++;
						}

						currentDate.setUTCDate(currentDate.getUTCDate() + 1);
					}

					return workingDays;
				}

				function calculateEndDate(startISO, daysCount) {
					const parseDate = (dateStr) => {
						// Если дата в формате dd.mm.yyyy
						if (dateStr.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
							const [d, m, y] = dateStr.split('.');
							return new Date(y, m-1, d);
						}
						return new Date(dateStr);
					};
					
					let date = new Date(startISO);
					let remaining = parseInt(daysCount, 10);

					if (isNaN(remaining) || remaining < 1) {
						return startISO;
					}
					remaining--;

					while (remaining > 0) {
						date.setDate(date.getDate() + 1);

						const mName = fullMonthNames[date.getMonth()];
						const dNum  = date.getDate();

						const isHoliday =
						Array.isArray(modalHolidays[mName]) &&
						modalHolidays[mName].includes(dNum);

						if (!isHoliday) {
							remaining--;
						}
					}

					// Форматируем обратно в YYYY-MM-DD
					const yyyy = date.getFullYear();
					const mm   = monthToNumber[fullMonthNames[date.getMonth()]];
					const dd   = String(date.getDate()).padStart(2, '0');
					return `${yyyy}-${mm}-${dd}`;
				}

				// Навешиваем слушатели на строку rowIndex
				function setupRowListeners(rowIndex) {
					const startInput = popup.querySelector(`.start-date.vacation-row-${rowIndex}`);
					const daysInput  = popup.querySelector(`.days-count.vacation-row-${rowIndex}`);
					const endInput   = popup.querySelector(`.end-date.vacation-row-${rowIndex}`);
					if (!startInput || !daysInput || !endInput) return;

					// Функция для автоматического обновления количества дней при изменении дат
					function updateWorkingDays() {
						const startDateValue = getRealDateValueFromInput(startInput);
						const endDateValue = getRealDateValueFromInput(endInput);
						
						if (startDateValue && endDateValue) {
							const workingDays = calculateWorkingDays(startDateValue, endDateValue);
							if (workingDays > 0) {
								daysInput.value = workingDays;
							} else {
								daysInput.value = '';
							}
						} else {
							daysInput.value = '';
						}
					}

					// Функция для обновления даты окончания по количеству дней
					function updateEnd() {
						const startDateValue = getRealDateValueFromInput(startInput);
						if (startDateValue && daysInput.value) {
							const endDateValue = calculateEndDate(startDateValue, daysInput.value);
							if (endInput._flatpickr) {
								endInput._flatpickr.setDate(endDateValue);
							} else {
								endInput.value = endDateValue;
							}
							// После обновления даты окончания пересчитываем дни
							setTimeout(updateWorkingDays, 100);
						}
					}

					// Инициализируем flatpickr с обработчиками onChange
					if (!startInput._flatpickr) {
						initFlatpickr(startInput, () => {
							updateWorkingDays();
							updateEnd();
						});
					}
					
					if (!endInput._flatpickr) {
						initFlatpickr(endInput, () => {
							updateWorkingDays();
						});
					}

					// Обработчики для расчета даты окончания по количеству дней
					startInput.addEventListener('change', () => {
						updateEnd();
						updateWorkingDays();
					});
					daysInput.addEventListener('input', updateEnd);

					// Обработчики для автоматического расчета количества дней при ручном вводе
					startInput.addEventListener('blur', updateWorkingDays);
					endInput.addEventListener('blur', updateWorkingDays);
				}

				setupRowListeners(1);

				const addBtn = popup.querySelector('#add-vacation-button');
				addBtn.addEventListener('click', () => {
					setTimeout(() => {
						setupRowListeners(vacationCounter);
					}, 0);
				});
			},
			confirmButtonText: 'Добавить отпуск сотрудника',
			cancelButtonText: 'Отмена',
			preConfirm: () => processVacationForm()
		});
	}

	function addVacationRow() {
		vacationCounter++;
		const grid = document.querySelector('.dates-grid');
		grid.insertAdjacentHTML('beforeend', `
			<div class="label-cell vacation-row-${vacationCounter}">Отпуск:</div>
			<input type="text" class="swal2-input start-date vacation-row-${vacationCounter}" required placeholder="дд.мм.гггг">
			<input type="number" min="1" class="swal2-input days-count vacation-row-${vacationCounter}" placeholder="0">
			<input type="text" class="swal2-input end-date vacation-row-${vacationCounter}" required placeholder="дд.мм.гггг">
			<img src="{% static 'delete.svg' %}" class="delete-row vacation-row-${vacationCounter}"
				onclick="removeVacationRow(${vacationCounter})">
		`);
	}

	function removeVacationRow(rowId) {
		const elements = document.querySelectorAll(`.vacation-row-${rowId}`);
		elements.forEach(el => el.remove());
	}

	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}
	
	async function processVacationForm() {
		const popup = Swal.getPopup();
		if (!popup) {
			return false;
		}

		const employeeId = popup.querySelector('#vacation-employee').value;
		
		// Находим все уникальные строки отпусков по классу vacation-row-X
		const vacationRows = new Set();
		const allInputs = popup.querySelectorAll('[class*="vacation-row-"]');
		
		allInputs.forEach(input => {
			const rowClass = Array.from(input.classList).find(cls => cls.startsWith('vacation-row-'));
			if (rowClass) {
				vacationRows.add(rowClass);
			}
		});

		const vacations = [];
		const vacationSet = new Set(); // Для предотвращения дубликатов

		// Функция для получения реального значения даты из flatpickr (формат YYYY-MM-DD)
		const getRealDateValue = (input) => {
			if (input._flatpickr) {
				const fp = input._flatpickr;
				
				// Если есть выбранная дата, форматируем её в YYYY-MM-DD
				if (fp.selectedDates.length > 0) {
					return fp.formatDate(fp.selectedDates[0], 'Y-m-d');
				}
				if (fp.input && fp.input.value) {
					return fp.input.value;
				}
			}
			
			let value = input.value;
			// Если значение в формате дд.мм.гггг, конвертируем в YYYY-MM-DD
			if (value && value.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
				const [d, m, y] = value.split('.');
				return `${y}-${m}-${d}`;
			}
			return value;
		};

		// Обрабатываем каждую строку отпуска
		for (const rowClass of vacationRows) {
			const allStartInputs = Array.from(popup.querySelectorAll(`.start-date.${rowClass}`));
			const allEndInputs = Array.from(popup.querySelectorAll(`.end-date.${rowClass}`));
			
			let startInput = allStartInputs.find(inp => inp._flatpickr) || allStartInputs[0];
			let endInput = allEndInputs.find(inp => inp._flatpickr) || allEndInputs[0];
			
			if (!startInput || !endInput) {
				continue; // Пропускаем неполные строки
			}
			
			let startDate = getRealDateValue(startInput);
			let endDate = getRealDateValue(endInput);

			if (!startDate || !endDate) {
				Swal.showValidationMessage('Заполните все обязательные поля');
				return false;
			}

			// Валидация дат
			if (new Date(startDate) > new Date(endDate)) {
				Swal.showValidationMessage('Дата начала не может быть позже даты окончания');
				return false;
			}
			
			// Создаем уникальный ключ для проверки дубликатов
			const vacationKey = `${employeeId}_${startDate}_${endDate}`;
			if (vacationSet.has(vacationKey)) {
				continue;
			}
			vacationSet.add(vacationKey);
			
			vacations.push({
				employee: employeeId,
				day_start: startDate,
				day_end: endDate
			});
		}

		// Проверяем, что есть хотя бы один отпуск для сохранения
		if (vacations.length === 0) {
			Swal.showValidationMessage('Не указано ни одного отпуска для сохранения');
			return false;
		}

		try {
			const csrftoken = getCookie('csrftoken_vacations');
			const response = await fetch('/users/save-vacations/', {
			method: 'POST',
			credentials: 'same-origin', 
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrftoken
			},
			body: JSON.stringify(vacations)
			});

			const responseData = await response.json();
			
			if (response.ok && responseData.status === 'success') {
				Swal.fire({
					title: 'Успешно!',
					text: 'Отпуска добавлены',
					icon: 'success',

					customClass: {
						popup: 'my-swal-popup',
						title: 'my-swal-title-success',
						content: 'my-swal-content',
						confirmButton: 'my-swal-button-success'
					},

					confirmButtonText: 'Отлично',
					background: 'white',
				})
					.then(() => window.location.reload());
			} else {
				// Получаем детали ошибки от сервера
				let errorMessage = 'Произошла ошибка при сохранении';
				if (responseData && responseData.message) {
					if (typeof responseData.message === 'string') {
						errorMessage = responseData.message;
					} else if (typeof responseData.message === 'object') {
						// Если сообщение - объект
						const errors = [];
						for (const [field, messages] of Object.entries(responseData.message)) {
							errors.push(`${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`);
						}
						errorMessage = 'Ошибки валидации:\n' + errors.join('\n');
					}
				}
				
				Swal.fire({
					title: 'Ошибка!',
					html: errorMessage.replace(/\n/g, '<br>'),
					icon: 'error',

					customClass: {
						popup: 'my-swal-popup',
						title: 'my-swal-title-error',
						content: 'my-swal-content',
						confirmButton: 'my-swal-button-error'
					},

					confirmButtonText: 'Понятно',
					background: 'white',
				});
			}
		} catch (error) {
			Swal.fire({
				title: 'Ошибка!',
				text: 'Нет соединения с сервером',
				icon: 'error',

				customClass: {
					popup: 'my-swal-popup',
					title: 'my-swal-title-error',
					content: 'my-swal-content',
					confirmButton: 'my-swal-button-error'
				},

				confirmButtonText: 'Закрыть',
				background: 'white',
			});
		}
	}
</script>
{% endblock %}