{% extends "base.html" %}
{% load user_filters %}
{% load cache %}
{% load static %}
{% block title %}Редактировать отпуск{% endblock %}
{% block header %}
<title>Редактирование отпуска</title>
<div style="display: flex; flex-direction: row; justify-content: left; align-items: center; flex-wrap: nowrap;">
    <a style="color: black; font-weight: bold; font-size: 28px; text-align: left; line-height: 50px; white-space: nowrap; margin-left: 358px;">Редактирование отпуска на {{ year }}</a>
</div>

<style>
    .table-container { width: 710px; margin: 0 auto; margin-top: 20px; margin-left: 358px; padding: 30px; background-color: white; box-shadow: 0px 0px 4px rgba(0, 0, 0, 0.2); border-radius: 5px; }
	.btn-edit { background-color: #15a362; font-family: 'Calibri'; font-style: normal; width: 180px; height: 40px; font-weight: 700; font-size: 18px; padding: 0 10px; border-radius: 5px; color: white; text-align: center; display: flex; align-items: center; justify-content: center; text-decoration: none; text-transform: none; margin: 0;}
	.btn-my-vacations { background-color: white; color: #5d6778; border: 1px solid #ccc; font-family: 'Calibri'; font-style: normal; font-weight: 700; width: 110px; height: 40px; font-size: 18px; padding: 0 10px; border-radius: 5px; text-align: center; display: flex; align-items: center; justify-content: center; text-decoration: none; margin-left: 30px; }
	.btn-edit:hover { background-color: rgba(21, 163, 98, 0.8); text-decoration: none; color: white; }
    .btn-edit:focus { outline: none; }
	.btn-my-vacations:hover { text-decoration: none; color: #15a362 !important; border: 1px solid #15a362; }
    .darker { color: #15a362; font-size: 17px; text-decoration: underline; cursor: pointer; }
    .darker:hover { color: green; }
    .tooltip-container { position: relative; display: inline-block; }
    .tooltip-text { visibility: hidden; width: 200px; background-color: rgba(0, 0, 0, 0.9); color: white; text-align: center; border-radius: 5px; padding: 5px; position: absolute; z-index: 2; bottom: 120%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 15px; }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    .tooltip-text::after { content: ""; position: absolute; bottom: -9px; left: 50%; transform: translateX(-50%); width: 0; height: 0; z-index: 1; border-left: 7px solid transparent; border-right: 7px solid transparent; border-top: 9px solid rgba(0, 0, 0, 0.9); }
    .form-control { width: 270px !important; height: 43px !important; font-size: 18px; background-color: white !important; border: 1px solid #ddd; border-radius: 5px; padding-left: 10px; transition: border-color 0.3s ease; }
    .form-control:focus { border-color: #0d6efd; outline: none; box-shadow: none; }
    .btn-delete { background-color: #d26d69; font-family: 'Calibri'; font-style: normal; font-weight: 700; width: 120px; height: 40px; font-size: 18px; padding: 0 10px; border-radius: 5px; color: white; text-align: center; display: flex; align-items: center; justify-content: center; text-decoration: none; margin-left: 210px; }
    .btn-delete:hover { background-color: rgba(210, 109, 105, 0.9); text-decoration: none; color: white; }
</style>
{% endblock %}

{% block aside %}
    {% include 'includes/aside_vac_all.html' %}
{% endblock %}

{% block content %}
<div class="table-container">
    <form method="post" enctype="multipart/form-data" style="width: 100%;">
        {% csrf_token %}

        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <label for="employee" style="font-size: 19px; flex: 0 0 230px; text-align: left; color: #5d6778;">
                Сотрудник<span style="color: red;">&nbsp;*</span>
            </label>
            <div style="font-size: 18px; color: #5d6778; flex: 1; text-align: left; margin-top: -6px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 500px;"
            title="{{ employee_name }}{% if employee_position %} ({{ employee_position }}){% endif %}">
                {{ employee_name }}{% if employee_position %} ({{ employee_position }}){% endif %}
            </div>
        </div>

        {% for field in form %}
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <label for="{{ field.id_for_label }}" style="font-size: 19px; flex: 0 0 230px; text-align: left; color: #5d6778;">
                    {{ field.label }}
                    {% if field.name in "day_start day_end" %}
                        <span style="color: red;">*</span>
                    {% elif field.name == "how_long" %}
                        <span class="tooltip-container">
                            <img src="{% static 'question.svg' %}" alt="info" style="width: 21px; height: 21px; cursor: pointer;">
                            <span class="tooltip-text">Укажите количество календарных дней и дата окончания рассчитается автоматически.</span>
                        </span>
                    {% endif %}
                </label>
                <div style="flex: 1; position: relative;">
                    {{ field }}
                    {% if field.errors %}
                    <div class="error"
                         style="
                            position: absolute;
                            top: 100%;
                            left: 2px;
                            margin-top: 7px;
                            font-size: 16px;
                            color: red;
                            white-space: nowrap;
                         ">
                        {{ field.errors|striptags }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
        {% endfor %}

        <div style="display: flex; justify-content: flex-start; margin-top: 30px;">
            <button class="btn-edit" type="submit">Сохранить отпуск</button>
            {% if request.GET.from == 'all_vacations' %}
                <a class="btn-my-vacations" href="{% url 'vac_all_vacations' %}">Отмена</a>
                <a class="btn-delete" href="{% url 'vacation_delete' vac_id=vac_id %}?from=all_vacations" onclick="confirmDeletion(event, this)">Удалить</a>
            {% elif request.GET.from == 'calendars' %}
                <a class="btn-my-vacations" href="{% url 'vac_2' year=year otd=0 %}">Отмена</a>
                <a class="btn-delete" href="{% url 'vacation_delete' vac_id=vac_id %}?from=calendars" onclick="confirmDeletion(event, this)">Удалить</a>
            {% elif request.GET.from == 'vac_all' %}
                <a class="btn-my-vacations" href="{% url 'vac_all' otd=0 %}">Отмена</a>
                <a class="btn-delete" href="{% url 'vacation_delete' vac_id=vac_id %}?from=vac_all" onclick="confirmDeletion(event, this)">Удалить</a>
            {% else %}
                <a class="btn-my-vacations" href="{% url 'vac_my_vacations' %}">Отмена</a>
                <a class="btn-delete" href="{% url 'vacation_delete' vac_id=vac_id %}" onclick="confirmDeletion(event, this)">Удалить</a>
            {% endif %}
        </div>
    </form>
</div>

<link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}">
<script src="{% static 'libs/flatpickr.min.js' %}"></script>
<script src="{% static 'libs/ru.js' %}"></script>

<script>
    function confirmDeletion(event, element) {
        event.preventDefault(); // Остановить переход по ссылке

        const userConfirmed = confirm("Вы уверены, что хотите удалить отпуск?");
        if (userConfirmed) {
            window.location.href = element.href;
        }
    }

    const holidays = JSON.parse('{{ holidays_json|escapejs }}');

    $(document).ready(function() {
        var year = {{ year }};

        // Функция для расчета количества рабочих дней между двумя датами
        function calculateWorkingDays(startDateStr, endDateStr) {
            if (!startDateStr || !endDateStr) {
                return 0;
            }

            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];

            const startDateParts = startDateStr.split('-');
            const endDateParts = endDateStr.split('-');

            if (startDateParts.length !== 3 || endDateParts.length !== 3) {
                return 0;
            }

            // Устанавливаем даты с нулевым временем для точности
            let currentDate = new Date(Date.UTC(startDateParts[0], startDateParts[1] - 1, startDateParts[2]));
            const endDate = new Date(Date.UTC(endDateParts[0], endDateParts[1] - 1, endDateParts[2]));

            if (currentDate > endDate) {
                return 0;
            }

            let workingDays = 0;

            while (currentDate <= endDate) {
                const currentMonthName = monthNames[currentDate.getUTCMonth()];
                const currentDay = currentDate.getUTCDate();
                const monthHolidays = holidays[currentMonthName] || [];

                // Если день не является праздником, учитываем его
                if (!monthHolidays.includes(currentDay)) {
                    workingDays++;
                }

                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }

            return workingDays;
        }

        // Функция для расчета даты окончания по количеству дней
        function calculateEndDate(startDateStr, daysCount) {
            if (!startDateStr) return null;
            
            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];

            const startDateParts = startDateStr.split('-');
            if (startDateParts.length !== 3) {
                return null;
            }

            let remaining = parseInt(daysCount, 10);
            if (isNaN(remaining) || remaining < 1) {
                return startDateStr;
            }

            let currentDate = new Date(Date.UTC(startDateParts[0], startDateParts[1] - 1, startDateParts[2]));
            remaining--;

            while (remaining > 0) {
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);

                const currentMonthName = monthNames[currentDate.getUTCMonth()];
                const currentDay = currentDate.getUTCDate();
                const monthHolidays = holidays[currentMonthName] || [];

                if (!monthHolidays.includes(currentDay)) {
                    remaining--;
                }
            }

            const yyyy = currentDate.getUTCFullYear();
            const mm = String(currentDate.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(currentDate.getUTCDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // Функция для автоматического обновления количества дней
        function updateWorkingDays() {
            const startDateStr = $('#id_day_start').val();
            const endDateStr = $('#id_day_end').val();

            if (startDateStr && endDateStr) {
                const workingDays = calculateWorkingDays(startDateStr, endDateStr);
                if (workingDays > 0) {
                    $('#id_how_long').val(workingDays);
                } else {
                    $('#id_how_long').val('');
                }
            } else {
                $('#id_how_long').val('');
            }
        }

        // Функция для автоматического обновления даты окончания при изменении количества дней
        function updateEndDate() {
            const startDateStr = $('#id_day_start').val();
            const daysCountStr = $('#id_how_long').val();

            if (startDateStr && daysCountStr) {
                const endDateStr = calculateEndDate(startDateStr, daysCountStr);
                if (endDateStr) {
                    $('#id_day_end').val(endDateStr);
                    const endInput = document.getElementById('id_day_end');
                    if (endInput && endInput._flatpickr) {
                        endInput._flatpickr.setDate(endDateStr);
                    }
                    // Пересчитываем дни после обновления даты
                    setTimeout(updateWorkingDays, 100);
                }
            }
        }

        function setDatepicker(year) {
            var minDate = new Date(year, 0, 1);
            var maxDate = new Date(year, 11, 31);

            flatpickr('#id_day_start', {
                minDate: minDate,
                maxDate: maxDate,
                locale: 'ru',
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                allowInput: true,
                onChange: function(selectedDates, dateStr, instance) {
                    updateWorkingDays();
                    updateEndDate();
                },
            });

            flatpickr('#id_day_end', {
                minDate: minDate,
                maxDate: maxDate,
                locale: 'ru',
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                allowInput: true,
                onChange: function(selectedDates, dateStr, instance) {
                    updateWorkingDays();
                },
            });
        }

        setDatepicker(year);

        // Добавляем обработчики для ручного ввода дат
        $('#id_day_start').on('blur change', function() {
            updateWorkingDays();
            updateEndDate();
        });
        $('#id_day_end').on('blur change', function() {
            updateWorkingDays();
        });

        // Добавляем обработчик для автоматического расчета даты окончания при изменении количества дней
        $('#id_how_long').on('input change', function() {
            updateEndDate();
        });

        // Инициализируем количество дней при загрузке страницы, если даты уже заполнены
        setTimeout(function() {
            updateWorkingDays();
        }, 100);

        // Функция для получения реального значения даты из flatpickr (формат YYYY-MM-DD)
        function getRealDateValue(inputId) {
            var input = document.getElementById(inputId);
            if (!input) return null;
            
            if (input._flatpickr) {
                // Если есть выбранная дата, форматируем её в YYYY-MM-DD
                if (input._flatpickr.selectedDates.length > 0) {
                    return input._flatpickr.formatDate(input._flatpickr.selectedDates[0], 'Y-m-d');
                }
                if (input._flatpickr.input) {
                    var realValue = input._flatpickr.input.value;
                    if (realValue) return realValue;
                }
            }
            
            var value = $('#' + inputId).val();
            // Если значение в формате дд.мм.гггг, конвертируем в YYYY-MM-DD
            if (value && value.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                var parts = value.split('.');
                return parts[2] + '-' + parts[1] + '-' + parts[0];
            }
            return value;
        }

        $('form').submit(function(event) {
            var startDate = getRealDateValue('id_day_start');
            var endDate = getRealDateValue('id_day_end');
            
            if (!startDate || !endDate) {
                return true; // Разрешаем стандартную валидацию формы
            }

            var startParts = startDate.split('-');
            var endParts = endDate.split('-');

            if (startParts.length !== 3 || endParts.length !== 3) {
                return true;
            }

            var start = new Date(startParts[0], startParts[1] - 1, startParts[2]);
            var end = new Date(endParts[0], endParts[1] - 1, endParts[2]);
            var startYear = parseInt(startParts[0], 10);
            var endYear = parseInt(endParts[0], 10);

            if (start > end) {
                alert('Дата начала должна быть до даты окончания отпуска.');
                event.preventDefault();
                return false;
            }
            
            // Проверка на пересечение годов
            if (startYear !== endYear) {
                alert('Отпуск не может переходить на следующий календарный год.');
                event.preventDefault();
                return false;
            }
        });
    });
</script>
{% endblock %}