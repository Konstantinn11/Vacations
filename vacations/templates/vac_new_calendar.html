{% extends "base.html" %}
{% load cache %}
{% block title %}Календарь{% endblock %}
{% load user_filters %}
{% load static %}
{% block header %}
<title>Календарь отпусков</title>
<link rel="stylesheet" href="{% static 'css/sweetalert2.min.css' %}">
<script src="{% static 'libs/sweetalert2.min.js' %}"></script>
<div style="display: flex; flex-direction: row; justify-content: left; align-items: center; flex-wrap: nowrap; width: 100%;">
    <a style="color: black; font-weight: bold; font-size: 38px; text-align: left; line-height: 50px; white-space: nowrap;">Календарь отпусков на {{year}}</a>
    <div style="display: flex; flex-direction: row; align-items: center; margin-left: 20px; gap: 20px; flex-grow: 1; justify-content: flex-end;">
        <div class="flex-container">
			<select name="filtr_otd" id="filtr_otd" style="font-size: 18px; padding: 5px 10px; border: 1px solid #5d6778; color: #5d6778; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; width: 140px; height: 35px; cursor: pointer;" onchange="updateDepartment()">
				<option value="0" disabled selected>Фильтр</option>
				{% for otd in otds_for_choise %}
					<option value="{{ otd }}" {% if otd == current_otd %}selected{% endif %}>{{ otd }}</option>
				{% endfor %}
				{% if request.user.get_full_name in bosses %}
					<option value="0" {% if current_otd == 0 %}selected{% endif %}>Все отделы</option>
				{% endif %}
			</select>

			<select id="filtr_year" name="filtr_year" style="font-size: 18px; padding: 5px 10px; border: 1px solid #5d6778; color: #5d6778; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; width: 140px; height: 35px; cursor: pointer;" onchange="updateFilters()">
				<option value="0" disabled selected>Год</option>
				{% for y in years_range %}
					<option value="{{ y }}">{{ y }}</option>
				{% endfor %}
			</select>

			{% if request.user.get_full_name in bosses %}
			<a href="{% url 'import_vacations' %}" id="import_link" style="display: inline-block; text-align: center; font-size: 18px; padding: 5px 15px; border: 1px solid #5d6778; border-radius: 3px; background-color: white; color: #5d6778; width: 140px; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; height: 35px; cursor: pointer; text-decoration: none;">
				Импорт
			</a>
			<a href="{% url 'export_vacations' year otd %}" id="export_link" style="display: inline-block; text-align: center; font-size: 18px; padding: 5px 15px; border: 1px solid #5d6778; border-radius: 3px; background-color: white; color: #5d6778; width: 140px; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; height: 35px; cursor: pointer; text-decoration: none;">
				Экспорт
			</a>
			{% endif %}
		</div>
    </div>
</div>

<div style="display: flex; flex-direction: row; justify-content: left; align-items: center; font-family: 'Calibri'; font-style: normal; font-weight: 400; line-height: 22px; font-size: 18px; color: #5d6778;">
    Параметры фильтрации: отдел<span style="margin-left: 2px; color: #20c997;">&nbsp;{% if otd == 0%}Все отделы{% else %}{{ otd }}{% endif %}</span>,&nbsp;год<span style="color: #20c997;">&nbsp;{{ year }}</span>.
</div>

{% if messages %}
    <div style="margin-bottom: 10px; font-size: 18px; text-align: center; width: 110%;">
        {% for message in messages %}
            <div id="message-{{ forloop.counter }}" style="padding: 10px; border-radius: 5px; 
                {% if message.tags == 'success' %}
					background-color: #d4edda; color: #155724; 
                {% elif message.tags == 'error' %}
                    background-color: #f8d7da; color: #721c24;
				{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    
    <script>
        setTimeout(function() {
            {% for message in messages %}
                var messageElement = document.getElementById("message-{{ forloop.counter }}");
                if (messageElement) {
                    messageElement.style.display = "none";
                }
            {% endfor %}
        }, 3000);
    </script>
{% endif %}

<script>
	var currentYear = "{{ year }}";
	var currentOtd = "{{ otd }}";

	function updateDepartment() {
		var selectedOtd = document.getElementById('filtr_otd').value;
		window.location.href = "{% url 'vac_2' 0 0 %}".replace("0/0", currentYear + "/" + selectedOtd);
	}
	
	function updateYearDropdown() {
		var selectedOtd = document.getElementById('filtr_otd').value;
		var yearDropdown = document.getElementById('filtr_year');
		if (selectedOtd != "0") {
			yearDropdown.style.display = 'inline-block'; 
		} else {
			yearDropdown.style.display = 'inline-block';
		}
	}

	function updateFilters() {
		var selectedYear = document.getElementById('filtr_year').value;

		if (selectedYear !== "0") {
			window.location.href = "{% url 'vac_2' 0 0 %}".replace("0/0", selectedYear + "/" + currentOtd);
		} else {
			alert('Пожалуйста, выберите год.');
		}
	}
</script>
{% endblock %}

{% block aside %}
    {% include 'includes/aside_vac_new.html' %}
{% endblock %}

{% block content %}
<style>
	.flex-container {
		display: flex;
		flex-direction: row;
		justify-content: flex-start;
		align-items: center;
		gap: 20px;
		width: 100%;
	}
	
	#filtr_otd {
		background-image: url("{% static 'funnel.svg' %}"), url("{% static 'arrow-drop.svg' %}");
		background-position: left 10px center, right 5px center;
		background-repeat: no-repeat, no-repeat;
		background-size: 20px 20px, 20px 20px;
		padding-left: 10px;
		padding-right: 3px; 
	}
	
	#filtr_year {
		background-image: url("{% static 'calendar.svg' %}"), url("{% static 'arrow-drop.svg' %}");
		background-position: left 10px center, right 5px center;
		background-repeat: no-repeat, no-repeat;
		background-size: 20px 20px, 20px 20px;
		padding-left: 10px;  
		padding-right: 3px; 
	}

	#import_link {
		background-image: url("{% static 'box-arrow-in-down-svgrepo.svg' %}");
		background-position: left 10px center;
		background-repeat: no-repeat;
		background-size: 20px 20px;
	}

	#export_link {
		background-image: url("{% static 'printer.svg' %}");
		background-position: left 10px center;
		background-repeat: no-repeat;
		background-size: 20px 20px;
	}

	#tooltip {
		position: absolute;
		background-color: rgba(0, 0, 0, 0.8);  
		color: white;  
		padding: 10px; 
		border-radius: 5px;  
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);  
		display: none;  
		z-index: 1000;  
	}

	.swal2-title {
		font-size: 26px; 
		color: #000000;
	}

	.table {
		font-size: 19px; 
	}

	@keyframes slideInTop {
	from {
		transform: translateY(-100%);
		opacity: 0;
	}
	to {
		transform: translateY(0);
		opacity: 1;
	}
	}

	@keyframes slideOutTop {
	from {
		transform: translateY(0);
		opacity: 1;
	}
	to {
		transform: translateY(-100%);
		opacity: 0;
	}
	}

	.custom-popup {
		min-width: 800px;
		width: auto;
		top: 60px; 
		position: fixed; 
		animation: slideInTop 0.5s ease-out;
	}

	.custom-popup.swal2-hide {
		animation: slideOutTop 0.5s ease-in forwards;
	}

	.ellipsis-cell {
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis;
		max-width: 300px;
		display: inline-block;
		vertical-align: middle;
	}
</style>
<div style="width: 110%; display: flex; flex-direction: row;">
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Январь" value=Январь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Февраль" value=Февраль %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Март" value=Март %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Апрель" value=Апрель %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Май" value=Май %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Июнь" value=Июнь %}</div>
</div>

<div style="width: 110%; display: flex; flex-direction: row;">
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Июль" value=Июль %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Август" value=Август %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Сентябрь" value=Сентябрь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Октябрь" value=Октябрь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Ноябрь" value=Ноябрь %}</div>
	<div style="margin: 5px 20px 5px 0px;">{% include "includes/vac_month_table.html" with key="Декабрь" value=Декабрь %}</div>
</div>
{% if len_cross_vacations > 0 %}
<div style="width: 110%; display: flex; flex-direction: row; margin-top: 15px;">
	<div style="background:linear-gradient(135deg, #df691a 22.22%, #4e5d6c 22.22%, #4e5d6c 50%, #df691a 50%, #df691a 72.22%, #4e5d6c 72.22%, #4e5d6c 100%);
	width: 80px; height: 20px;">
	</div>
	<a>&nbsp;- дни с пересекающимися отпусками от 2 сотрудников.</a>
</div>
{% endif %}
<div id="tooltip"></div>
<div style="width: 110%; display: flex; flex-direction: row; margin-top: 15px;">
	<table style="width: 900px;">
		<tr style="border-bottom: 1px solid black;">
			<th style="text-align: left;">Сотрудник</th><th>Отдел</th><th>Дней</th>
		</tr>

		{% for key, value in vacations_by_user.items %}
			<tr style="border-bottom: 1px solid rgb(187, 185, 185); height: 40px;"
				class="vacation-cell" 
				data-employee-name="{{key}}"
				data-start-date="{% for start_date, days_count in value.vacation_start_dates %}{{start_date}}{% if not forloop.last %}, {% endif %}{% endfor %}" 
				data-end-date="{% for end_date in value.vacation_end_dates %}{{end_date}}{% if not forloop.last %}, {% endif %}{% endfor %}"
				data-vac-id="{% for vac in value.dates %}{{ vac.vac_id }}{% if not forloop.last %}, {% endif %}{% endfor %}">
				<th style="text-align: left;">
					<div style="display: flex; flex-direction: row; justify-content: left; align-items: center;">
						<div style="width: 15px; height: 15px; background: {{value.color}}; border: 1px solid black; margin-right: 6px;"></div>
						<a style="color: black" href="#" onclick="filtrByUser(this)">{{value.user.get_full_name}}</a>
					</div>
				</th>
				<th>{{value.otd }}</th>
				<th>{{value.sum }}</th>
			</tr>
		{% endfor %}
	</table>
	<div style="border: 1px solid rgb(187, 185, 185); padding: 5px;">
		<div id="vacation-message">В данный момент нет сотрудников в отпуске.</div>
		<div id="info" style="margin-top: 20px; border: 1px solid rgb(187, 185, 185);"></div>
	</div>
</div>

<script>
	if (window.history.replaceState) {
		window.history.replaceState(null, null, window.location.href);
	}

	let data = JSON.parse("{{json_data|escapejs}}");
	let vacs = JSON.parse("{{json_data_vacs|escapejs}}");
	const bosses = JSON.parse('{{ bosses_list|escapejs }}');
	const currentUser = "{{ current_user_name|escapejs }}";
	const user_names = JSON.parse('{{ user_names|escapejs }}');

	// Универсальные массивы и объекты месяцев
	const monthNames = [
		"", "января", "февраля", "марта", "апреля", "мая", "июня",
		"июля", "августа", "сентября", "октября", "ноября", "декабря"
	];
	const fullMonthNames = [
		"Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
		"Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
	];
	const monthToNumber = {
		"Январь": "01", "Февраль": "02", "Март": "03", "Апрель": "04",
		"Май": "05", "Июнь": "06", "Июль": "07", "Август": "08",
		"Сентябрь": "09", "Октябрь": "10", "Ноябрь": "11", "Декабрь": "12"
	};

	function isBoss(userName) {
		return bosses.includes(userName);
	}

	function getMonthName(monthNumber) {
		return monthNames[parseInt(monthNumber)];
	}

	function getMonthLabel(month) {
		return (month === "Март" || month === "Август")
			? month + 'а'
			: month.substring(0, month.length - 1) + 'я';
	}

	function showCrossData(obj) {
		let [month, week, day] = obj.id.split('_');
		day = Number(day);
		let info = document.getElementById('info');
		let messageDiv = info.previousElementSibling;

		let month_for_lbl = getMonthLabel(month);
		let innerHtml = data[month][week][day]["name"] + ' ' + month_for_lbl + ' {{year}}';

		if (Object.keys(data[month][week][day]['date']).length > 0) {
			for (const [user_id, v] of Object.entries(data[month][week][day]['date'])) {
				let [first_date, second_date] = v['date'].split(' - ');
				let [day1, month1] = first_date.split('-').reverse();
				let [day2, month2] = second_date.split('-').reverse();
				let period = `${day1} ${getMonthName(month1)} - ${day2} ${getMonthName(month2)}`;
				let user_name = user_names[user_id] || "Неизвестный пользователь";

				innerHtml += `
					<div style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
						<div style="width: 15px; height: 15px; background: ${v['color']}; border: 1px solid black; margin-right: 6px;"></div>
						<div>${user_name}</div>
					</div>
					<div>${period}</div>`;
			}
			messageDiv.innerText = "В данный момент есть сотрудники в отпуске:";
			info.style.display = "block";
		} else {
			info.innerHTML = '';
			info.style.display = "none";
			messageDiv.innerText = "В данный момент нет сотрудников в отпуске.";
		}
		info.innerHTML = innerHtml;
	}

	document.addEventListener("DOMContentLoaded", function () {
		const currentDate = new Date();
		const currentDay = currentDate.getDate();
		const currentMonth = currentDate.getMonth();
		const currentYear = currentDate.getFullYear();

		const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
		const firstWeekday = firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1;
		const currentWeekday = currentDate.getDay() === 0 ? 6 : currentDate.getDay() - 1;
		const weekOffset = Math.floor((currentDay + firstWeekday - 1) / 7) + 1;

		const month = fullMonthNames[currentMonth];
		const currentId = `${month}_${weekOffset}_${currentWeekday}`;

		const currentDayElement = document.getElementById(currentId);
		if (currentDayElement) {
			showCrossData(currentDayElement);
		}
	});

	function getEmployeeDepartment(employeeName) {
		let rows = document.querySelectorAll(".vacation-cell");
		for (let row of rows) {
			if (row.getAttribute("data-employee-name").trim() === employeeName.trim()) {
				return row.querySelector("th:nth-child(2)").innerText.trim();
			}
		}
		return "Отдел не указан";
	}

	function showCalendarPopup(obj) {
		let [month, week, dayIndex] = obj.id.split('_');
		dayIndex = Number(dayIndex);
		let day = data[month][week][dayIndex]?.name || dayIndex;
		let month_for_lbl = getMonthLabel(month).toLowerCase();
		const year = "{{year}}";
		let title = `Отпуска на ${day} ${month_for_lbl} ${year}`;
		let monthNumber = monthToNumber[month] || "00";
		let formattedDay = day < 10 ? `0${day}` : day;
		let formattedDate = `${formattedDay}.${monthNumber}.${year}`;

		let vacationData = [];
		if (Object.keys(data[month][week][dayIndex]['date']).length > 0) {
			for (const [user_id, info] of Object.entries(data[month][week][dayIndex]['date'])) {
				let user_name = user_names[user_id] || "Неизвестный пользователь";
				let period = formatVacationPeriod(info['date']);
				let department = getEmployeeDepartment(user_id);
				vacationData.push({ name: user_name, period, department, color: info['color'], vac_id: info['vac_id'] });
			}
		}

		let content = '';
		if (vacationData.length > 0) {
			content += `<table class="table" style="width: 100%;">
				<thead>
					<tr>
						<th>Сотрудник</th>
						<th>Отдел</th>
						<th>Период</th>
					</tr>
				</thead>
				<tbody>`;
			for (let entry of vacationData) {
				const editUrl = `/users/vacations/vacation_edit/${year}/${entry.vac_id}/?from=calendars`;
				content += `<tr>
					<td>
						<div style="display: flex; align-items: center;">
							<div style="width: 15px; height: 15px; background: ${entry.color}; border: 1px solid black; margin-right: 6px;"></div>
							<a href="#" class="ellipsis-cell" style="color: #15a362;" title="${entry.name}">${entry.name}</a>
						</div>
					</td>
					<td><span class="ellipsis-cell" title="${entry.department}">${entry.department}</span></td>
					<td>
						<span class="ellipsis-cell" title="${entry.period}" style="font-style: italic; ${isBoss(currentUser) || currentUser === entry.name ? 'text-decoration: underline; color: #15a362;' : 'color: black;'}">
							${isBoss(currentUser) || currentUser === entry.name ? `<a href="${editUrl}" style="color: inherit; text-decoration: inherit;">${entry.period}</a>` : entry.period}
						</span>
					</td>
				</tr>`;
			}
			content += `</tbody></table>`;
		} else {
			content = `<div style="font-size: 22px;">Не найдено отпусков за <strong>${formattedDate}</strong></div>`;
		}

		title += `<span style="background-color: #5b99ea; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">${vacationData.length} чел.</span>`;
		
		const wrapped = `<div style="text-align: left;">${content}</div>`;
		
		Swal.fire({
			title: `<div style="text-align: left;">${title}</div>`,
			html: wrapped,
			showCloseButton: true,
			showConfirmButton: false,
			customClass: {
				popup: 'custom-popup'
			}
		});

		const closeButton = document.querySelector('.swal2-close');
		if (closeButton) {
			closeButton.style.outline = 'none';
		}
	}

	function formatVacationPeriod(dateRange) {
		let [start, end] = dateRange.split(' - ');
		let [day1, month1] = start.split('-').reverse();
		let [day2, month2] = end.split('-').reverse();
		return `${day1} ${getMonthName(month1)} - ${day2} ${getMonthName(month2)}`;
	}

	let tooltipTimeout;

	function startTooltipTimeout(event, month, week, day) {
		clearTimeout(tooltipTimeout);
		tooltipTimeout = setTimeout(() => {
			if (data[month]?.[week]?.[day]?.['date'] && Object.keys(data[month][week][day]['date']).length > 0) {
				showTooltip(event, month, week, day);
			}
		}, 400);
	}

	function clearTooltipTimeout() {
		clearTimeout(tooltipTimeout);
		hideTooltip();
	}

	function showTooltip(event, month, week, day) {
		let tooltip = document.getElementById('tooltip');
		if (data[month][week][day] && Object.keys(data[month][week][day]['date']).length > 0) {
			let tooltipContent = '';
			for (const [user_id, v] of Object.entries(data[month][week][day]['date'])) {
				let [start, end] = v['date'].split(' - ');
				let [day1, month1] = start.split('-').reverse();
				let [day2, month2] = end.split('-').reverse();
				let user_name = user_names[user_id] || "Неизвестный пользователь";

				tooltipContent += `<div style="color: ${v['color']};">${user_name}</div>
					<div>${day1} ${getMonthName(month1)} - ${day2} ${getMonthName(month2)}</div>`;
			}
			tooltip.innerHTML = tooltipContent;
			tooltip.style.display = 'block';
			tooltip.style.left = event.pageX + 'px';
			tooltip.style.top = (event.pageY - tooltip.offsetHeight - 12) + 'px';
		} else {
			hideTooltip();
		}
	}

	function hideTooltip() {
		let tooltip = document.getElementById('tooltip');
		tooltip.style.display = 'none';
		tooltip.innerHTML = '';
	}

	function filtrByUser(obj) {
		let row = obj.closest('tr');
		let employeeId = row.getAttribute('data-employee-name');
		let days = document.getElementsByName('day');

		for (let i = 0; i < days.length; i++) {
			let [month, week, day] = days[i].id.split('_');
			if (data[month][week][day]) {
				for (const [k, v] of Object.entries(data[month][week][day]['data'])) {
					if (k !== employeeId) {
						days[i].childNodes[1].style.background = (day == 5 || day == 6)
							? 'rgb(219, 219, 219)'
							: 'transparent';
						days[i].childNodes[1].style.color = '#808080';
					} else {
						days[i].childNodes[1].style.background = 'linear-gradient(135deg, #df691a 50%, #4e5d6c 50%, #4e5d6c 100%)';
						days[i].childNodes[1].style.color = 'white';
						days[i].childNodes[1].style.borderRadius = '5px';
						days[i].childNodes[1].style.backgroundSize = '28px 28px';
						days[i].childNodes[1].style.backgroundPosition = 'center';
						days[i].childNodes[1].style.backgroundRepeat = 'no-repeat';
						break;
					}
				}
			}
		}
	}
</script>
{% endblock %}